------KHACHHANG
--KIEMTRA
USE Northwind
IF OBJECT_ID('KHACHHANG') IS NOT NULL
DROP TABLE KHACHHANG 
GO
CREATE TABLE KHACHHANG
(
 MAKH NVARCHAR(10) NOT NULL,
 HOTEN NVARCHAR(50) NULL,
 DIACHI NVARCHAR(100) NULL,
 EMAIL NVARCHAR(100) NULL,
 DIENTHOAI NVARCHAR(50)NULL,
 --KHOA CHINH
 CONSTRAINT PK_KHACHHANG PRIMARY KEY(MAKH)
)

------SANPHAM
--KIEMTRA
IF OBJECT_ID('SANPHAM') IS NOT NULL
DROP TABLE SANPHAM
GO
CREATE TABLE SANPHAM
(
 MASP NVARCHAR(10) NOT NULL,
 MOTA NVARCHAR(50) NULL,
 GIA MONEY,
 SOLUONG INT,
 TENSANPHAM NVARCHAR(20)NULL,
 --KHOA CHINH
 CONSTRAINT PK_SANPHAM PRIMARY KEY(MASP)
)

------HOADON
--KIEMTRA
IF OBJECT_ID('HOADON') IS NOT NULL
DROP TABLE HOADON
GO
CREATE TABLE HOADON
(
 MAHD NVARCHAR(10) NOT NULL,
 NGAYMUA DATE,
 MAKH NVARCHAR(10),
 TRANGTHAI NVARCHAR(50),
 --KHOA CHINH
 CONSTRAINT PK_HOADON PRIMARY KEY(MAHD),
 CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG
)


------HOADONCHITIET
--KIEMTRA
IF OBJECT_ID('HOADONCHITIET') IS NOT NULL
DROP TABLE HOADONCHITIET
GO
CREATE TABLE HOADONCHITIET
(
 MAHD NVARCHAR(10) NOT NULL,
 MASP NVARCHAR (10) NOT NULL,
 SOLUONGBAN INT,
 TRANGTHAI NVARCHAR(50),
 CONSTRAINT FK_HOADONCHITIET_HOADON FOREIGN KEY (MAHD) REFERENCES HOADON,
 CONSTRAINT FK_HOADONCHITIET_SANPHAM FOREIGN KEY (MASP) REFERENCES SANPHAM,
 CONSTRAINT PK_HOADONCHITIET PRIMARY KEY (MASP,MAHD),
)
--NHẬP DỮ LIỆU VÀO BẢNG
DELETE FROM HOADONCHITIET
GO
DELETE FROM SANPHAM
GO
DELETE FROM HOADON
GO
DELETE FROM KHACHHANG
GO
INSERT INTO KHACHHANG(MAKH,HOTEN,DIACHI,EMAIL,DIENTHOAI) 
VALUES (N'PH01',N'NGUYỄN THU THẢO',N'PHÚ MINH-PHÚC LÝ-MINH KHAI-BẮC TỪ LIÊM-HÀ NỘI',N'THAONTPH06790@FPT.EDU.VN','01673502523')
GO
INSERT INTO KHACHHANG(MAKH,HOTEN,DIACHI,EMAIL,DIENTHOAI) 
VALUES (N'PH02',N'TRẦN VĂN MINH',N'LA KHÊ-HÀ ĐÔNG-HÀ NỘI',N'MINHTV2409@GMAIL.COM','01699860112')
GO
INSERT INTO KHACHHANG(MAKH,HOTEN,DIACHI,EMAIL,DIENTHOAI) 
VALUES (N'PH03',N'LÊ THỊ HUYỀN',N'VĂN TRÌ-MINH KHAI-BẮC TỪ LIÊM-HÀ NỘI',N'HUYENLT2401@GMAIL.COM','01642543440')
GO
INSERT INTO KHACHHANG(MAKH,HOTEN,DIACHI,EMAIL,DIENTHOAI) 
VALUES (N'PH04',N'NGUYỄN THỌ VŨ',N'PHÚ ĐÔ-MỸ ĐÌNH-HÀ NỘI',N'VUNT1909@GMAIL.COM','0988606689')
GO
INSERT INTO KHACHHANG(MAKH,HOTEN,DIACHI,EMAIL,DIENTHOAI) 
VALUES (N'PH05',N'PHẠM CHI MAI',N'CIPUTRA-TÂY HỒ-HÀ NỘI',N'MAIPC2907@GMAIL.COM','0973657350')
GO 
INSERT INTO SANPHAM(MASP,TENSANPHAM,MOTA,GIA,SOLUONG) VALUES (N'DG1',N'BÀN LÀM VIỆC',N'RỘNG 1M2-MÀU XÁM',1050000,100)
GO
INSERT INTO SANPHAM(MASP,TENSANPHAM,MOTA,GIA,SOLUONG) VALUES (N'DG2',N'GHẾ GIÁM ĐỐC',N'MÀU ĐEN',3500000,10)
GO
INSERT INTO SANPHAM(MASP,TENSANPHAM,MOTA,GIA,SOLUONG) VALUES (N'DG3',N'BÀN GẤP',N'MÀU VÀNG',600000,50)
GO
INSERT INTO SANPHAM(MASP,TENSANPHAM,MOTA,GIA,SOLUONG) VALUES (N'DG4',N'BÀN TRANG ĐIỂM',N'MÀU TRẮNG',5000000,30)
GO
INSERT INTO SANPHAM(MASP,TENSANPHAM,MOTA,GIA,SOLUONG) VALUES (N'DG5',N'BÀN LÀM VIỆC KIỂU L',N'RỘNG 1M2-MÀU ĐEN',7800000,50)
GO
INSERT INTO HOADON(MAHD,MAKH,NGAYMUA,TRANGTHAI) VALUES (N'HD01',N'PH01',N'2018-09-29',N'ĐÃ THANH TOÁN')
GO
INSERT INTO HOADON(MAHD,MAKH,NGAYMUA,TRANGTHAI) VALUES (N'HD02',N'PH02',N'2018-07-18',N'ĐÃ THANH TOÁN')
GO
INSERT INTO HOADON(MAHD,MAKH,NGAYMUA,TRANGTHAI) VALUES (N'HD03',N'PH03',N'2018-06-06',N'ĐÃ THANH TOÁN')
GO
INSERT INTO HOADON(MAHD,MAKH,NGAYMUA,TRANGTHAI) VALUES (N'HD04',N'PH04',N'2018-01-24',N'ĐÃ THANH TOÁN')
GO
INSERT INTO HOADON(MAHD,MAKH,NGAYMUA,TRANGTHAI) VALUES (N'HD05',N'PH05',N'2018-10-17',N'ĐÃ THANH TOÁN')
GO
INSERT INTO HOADONCHITIET(MAHD,MASP,SOLUONGBAN,TRANGTHAI) VALUES (N'HD01',N'DG1',10,N'ĐÃ THANH TOÁN')
GO
INSERT INTO HOADONCHITIET(MAHD,MASP,SOLUONGBAN,TRANGTHAI) VALUES (N'HD02',N'DG2',1,N'ĐÃ THANH TOÁN')
GO
INSERT INTO HOADONCHITIET(MAHD,MASP,SOLUONGBAN,TRANGTHAI) VALUES (N'HD03',N'DG3',2,N'ĐÃ THANH TOÁN')
GO
INSERT INTO HOADONCHITIET(MAHD,MASP,SOLUONGBAN,TRANGTHAI) VALUES (N'HD04',N'DG4',5,N'ĐÃ THANH TOÁN')
GO
INSERT INTO HOADONCHITIET(MAHD,MASP,SOLUONGBAN,TRANGTHAI) VALUES (N'HD05',N'DG5',1,N'ĐÃ THANH TOÁN')
SELECT * FROM KHACHHANG
SELECT * FROM SANPHAM
SELECT * FROM HOADON
SELECT * FROM HOADONCHITIET

a Hiển thị tất cả thông tin có trong bảng khách hàng bao gồm tất cả các cột
SELECT * FROM KHACHHANG
b. Hiển thị 10 khách hàng đầu tiên trong bảng khách hàng bao gồm các cột: mã
khách hàng, họ và tên, email, số điện thoại
SELECT TOP 5 MAKH,HOTEN,EMAIL,DIENTHOAI FROM KHACHHANG
c. Hiển thị thông tin từ bảng Sản phẩm gồm các cột: mã sản phẩm, tên sản phẩm,
tổng tiền tồn kho. Với tổng tiền tồn kho = đơn giá* số lượng
SELECT MASP,TENSANPHAM, GIA*SOLUONG AS TONGTIENKHO FROM SANPHAM
d. Hiển thị danh sách khách hàng có tên bắt đầu bởi kí tự ‘H’ gồm các cột:
maKhachHang, hoVaTen, diaChi. Trong đó cột hoVaTen ghép từ 2 cột
hoVaTenLot và Ten
SELECT MAKH,HOTEN,DIACHI FROM KHACHHANG
WHERE HOTEN LIKE '%M%'
e. Hiển thị tất cả thông tin các cột của khách hàng có địa chỉ chứa chuỗi ‘Đà Nẵng’
SELECT * FROM KHACHHANG
WHERE DIACHI LIKE '%MINH KHAI%'
f. Hiển thị các sản phẩm có số lượng nằm trong khoảng từ 100 đến 500.
SELECT * FROM SANPHAM
WHERE SOLUONG BETWEEN 100 AND 500
g. Hiển thị danh sách các hoá hơn có trạng thái là chưa thanh toán và ngày mua hàng
trong năm 2016
SELECT * FROM HOADON
WHERE TRANGTHAI LIKE '%THANH%' AND YEAR (NGAYMUA) = 2018
h. Hiển thị các hoá đơn có mã Khách hàng thuộc 1 trong 3 mã sau: KH001, KH003, KH006
SELECT* FROM HOADON
WHERE MAKH='PH01' OR MAKH='PH02' OR MAKH='PH03'
-----BAI2
a. Hiển thị số lượng khách hàng có trong bảng khách hàng
SELECT COUNT (*) AS SOLUONGKHACH FROM KHACHHANG
b. Hiển thị đơn giá lớn nhất trong bảng SanPham
SElECT MAX (GIA) AS DONGIALONNHAT FROM SANPHAM
c. Hiển thị số lượng sản phẩm thấp nhất trong bảng sản phẩm
SELECT MIN (SOLUONG) AS SOLUONGTHAPNHAT FROM SANPHAM
d. Hiển thị tổng tất cả số lượng sản phẩm có trong bảng sản phẩm
SELECT SUM (SOLUONG) AS TONGSOLUONG FROM SANPHAM
e. Hiển thị số hoá đơn đã xuất trong tháng 12/2016 mà có trạng thái chưa thanh toán
SELECT * FROM HOADON
WHERE TRANGTHAI LIKE '%THANH%' AND DAY (NGAYMUA) = 29
f. Hiển thị mã hoá đơn và số loại sản phẩm được mua trong từng hoá đơn.
SELECT MAHD, COUNT (MASP) AS SOLOAISANPHAM FROM HOADONCHITIET
GROUP BY MAHD,MASP
g. Hiển thị mã hoá đơn và số loại sản phẩm được mua trong từng hoá đơn. Yêu cầu
chỉ hiển thị hàng nào có số loại sản phẩm được mua >=5.
SELECT MAHD, COUNT(MASP) SOLOAISANPHAM FROM HOADONCHITIET
GROUP BY MAHD,MASP
HAVING COUNT (MASP)>=1
h. Hiển thị thông tin bảng HoaDon gồm các cột maHoaDon, ngayMuaHang,
maKhachHang. Sắp xếp theo thứ tự giảm dần của ngayMuaHang
SELECT MAHD,NGAYMUA,MAKH FROM HOADON
ORDER BY NGAYMUA DESC

Bài 1 (4 điểm) Viết các câu truy vấn sau:
a. Hiển thị tất cả thông tin có trong 2 bảng Hoá đơn và Hoá đơn chi tiết gồm các cột
sau: maHoaDon, maKhachHang, trangThai, maSanPham, soLuong, ngayMua
SELECT HOADONCHITIET.MAHD,MAKH,HOADONCHITIET.TRANGTHAI,MASP,SOLUONGBAN,NGAYMUA
FROM HOADON JOIN HOADONCHITIET
ON HOADON.MAHD = HOADONCHITIET.MAHD
b. Hiển thị tất cả thông tin có trong 2 bảng Hoá đơn và Hoá đơn chi tiết gồm các cột
sau: maHoaDon, maKhachHang, trangThai, maSanPham, soLuong, ngayMua với
điều kiện maKhachHang = ‘KH001’
SELECT HOADONCHITIET.MAHD,MAKH,HOADONCHITIET.TRANGTHAI,MASP,SOLUONGBAN,NGAYMUA
FROM HOADON JOIN HOADONCHITIET
ON HOADON.MAHD = HOADONCHITIET.MAHD 
WHERE MAKH = 'PH01'
c. Hiển thị thông tin từ 3 bảng Hoá đơn, Hoá đơn chi tiết và Sản phẩm gồm các cột
sau: maHoaDon, ngayMua, tenSP, donGia, soLuong mua trong hoá đơn, thành
tiền. Với thành tiền= donGia* soLuong
SELECT HOADONCHITIET.MAHD,NGAYMUA,TENSANPHAM,GIA,SOLUONGBAN,GIA*SOLUONGBAN AS THANHTIEN
FROM HOADON JOIN HOADONCHITIET
ON HOADON.MAHD=HOADONCHITIET.MAHD 
JOIN SANPHAM
ON HOADONCHITIET.MASP=SANPHAM.MASP

d. Hiển thị thông tin từ bảng khách hàng, bảng hoá đơn, hoá đơn chi tiết gồm các
cột: họ và tên khách hàng, email, điện thoại, mã hoá đơn, trạng thái hoá đơn và
tổng tiền đã mua trong hoá đơn. Chỉ hiển thị thông tin các hoá đơn chưa thanh
toán.
SELECT HOTEN,EMAIL,DIENTHOAI,HOADON.MAHD,HOADON.TRANGTHAI,SUM(GIA*SOLUONGBAN) AS TONGTIENMUA
FROM KHACHHANG JOIN HOADON
ON KHACHHANG.MAKH=HOADON.MAKH
JOIN HOADONCHITIET
ON HOADON.MAHD=HOADONCHITIET.MAHD
JOIN SANPHAM
ON HOADONCHITIET.MASP=SANPHAM.MASP
WHERE HOADONCHITIET.TRANGTHAI LIKE '%THANH%'
GROUP BY HOTEN,EMAIL,DIENTHOAI,HOADON.MAHD,HOADON.TRANGTHAI
e. Hiển thị maHoaDon, ngàyMuahang, tổng số tiền đã mua trong từng hoá đơn. Chỉ
hiển thị những hóa đơn có tổng số tiền >=500.000 và sắp xếp theo thứ tự giảm dần
của cột tổng tiền.
SELECT HOADONCHITIET.MAHD,NGAYMUA,SUM(GIA*SOLUONGBAN) AS TONGTIENMUA 
FROM HOADON JOIN HOADONCHITIET
ON HOADON.MAHD = HOADONCHITIET.MAHD
JOIN SANPHAM
ON HOADONCHITIET.MASP= SANPHAM.MASP
GROUP BY HOADONCHITIET.MAHD,NGAYMUA
HAVING SUM(GIA*SOLUONGBAN) >=2000000
ORDER BY SUM(GIA*SOLUONGBAN) DESC
Yêu cầu: Nộp lại file chứa các câu lệnh T-SQL


Bài 2 (4 điểm) Viết các câu truy vấn sau:
a. Hiển thị danh sách các khách hàng chưa mua hàng lần nào kể từ tháng 1/1/2016
SELECT * FROM HOADON
WHERE TRANGTHAI LIKE '%THANH%' AND NGAYMUA BETWEEN '2018-01-01' AND '2018-06-30'
b. Hiển thị mã sản phẩm, tên sản phẩm có lượt mua nhiều nhất trong tháng 12/2016
SELECT TOP 1 HOADONCHITIET.MASP,TENSANPHAM,COUNT(HOADONCHITIET.MASP) AS MUANHIEUNHAT
FROM SANPHAM JOIN HOADONCHITIET
ON SANPHAM.MASP=HOADONCHITIET.MASP
GROUP BY HOADONCHITIET.MASP,TENSANPHAM
ORDER BY HOADONCHITIET.MASP DESC
c. Hiển thị top 5 khách hàng có tổng số tiền mua hàng nhiều nhất trong năm 2016
SELECT TOP 2 HOADON.MAKH,COUNT (MAKH) AS ABC
FROM HOADON
WHERE YEAR (NGAYMUA) = 2018
GROUP BY MAKH
ORDER BY MAKH DESC
d. Hiển thị thông tin các khách hàng sống ở ‘Đà Nẵng’ có mua sản phẩm có tên
“Iphone 7 32GB” trong tháng 12/2016
SELECT KHACHHANG.*, TENSANPHAM,NGAYMUA
FROM KHACHHANG JOIN HOADON
ON KHACHHANG.MAKH = HOADON.MAKH
JOIN HOADONCHITIET
ON HOADON.MAHD= HOADONCHITIET.MAHD
JOIN SANPHAM
ON HOADONCHITIET.MASP =  SANPHAM.MASP
WHERE YEAR (NGAYMUA) =2018 AND DIACHI LIKE '%MINH KHAI%' AND TENSANPHAM = N'%BÀN LÀM VIỆC%'
e. Hiển thị tên sản phẩm có lượt đặt mua nhỏ hơn lượt mua trung bình các các sản
phẩm.
SELECT TENSANPHAM, SOLUONGBAN AS LOUTMUA
FROM SANPHAM JOIN HOADONCHITIET 
ON SANPHAM.MASP = HOADONCHITIET.MASP
WHERE SOLUONGBAN < (SELECT AVG(SOLUONGBAN) FROM HOADONCHITIET)
Yêu cầu: Nộp lại file chứa các câu lệnh